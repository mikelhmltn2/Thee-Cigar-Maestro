<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Search comprehensive cigar specifications including length, ring gauge, strength, wrapper, and tasting notes.">
  <title>Specs | Thee Cigar Maestro</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Roboto&display=swap" rel="stylesheet">
  <style>
    /* Enhanced styles for improved functionality */
    .search-container {
      position: relative;
      max-width: 600px;
      margin: 0 auto;
    }

```
.search-input-wrapper {
  position: relative;
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.search-input {
  flex: 1;
  padding: 12px 16px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-size: 16px;
  transition: border-color 0.3s ease;
}

.search-input:focus {
  outline: none;
  border-color: #8B4513;
  box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1);
}

.search-input.error {
  border-color: #dc3545;
  box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
}

.search-button {
  padding: 12px 24px;
  background: #8B4513;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  min-width: 100px;
}

.search-button:hover:not(:disabled) {
  background: #6D340F;
}

.search-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.loading-spinner {
  display: none;
  width: 20px;
  height: 20px;
  border: 2px solid #ffffff;
  border-top: 2px solid transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 8px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.autocomplete-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 80px;
  background: white;
  border: 1px solid #ddd;
  border-top: none;
  border-radius: 0 0 8px 8px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
}

.autocomplete-item {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
  transition: background-color 0.2s ease;
}

.autocomplete-item:hover,
.autocomplete-item.selected {
  background: #f8f9fa;
}

.autocomplete-item:last-child {
  border-bottom: none;
}

.results-box {
  min-height: 100px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
  margin-top: 20px;
}

.results-box.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  color: #666;
}

.error-message {
  color: #dc3545;
  background: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 4px;
  padding: 12px;
  margin: 10px 0;
}

.success-message {
  color: #155724;
  background: #d4edda;
  border: 1px solid #c3e6cb;
  border-radius: 4px;
  padding: 12px;
  margin: 10px 0;
}

.search-history {
  margin-top: 20px;
}

.search-history h3 {
  margin-bottom: 10px;
  color: #333;
}

.history-item {
  display: inline-block;
  padding: 6px 12px;
  background: #e9ecef;
  border-radius: 20px;
  margin: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.2s ease;
}

.history-item:hover {
  background: #dee2e6;
}

.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

.spec-result {
  background: white;
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #dee2e6;
  margin-top: 10px;
}

.spec-result h3 {
  color: #8B4513;
  margin-bottom: 15px;
  border-bottom: 2px solid #8B4513;
  padding-bottom: 5px;
}

.spec-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.spec-item {
  background: #f8f9fa;
  padding: 12px;
  border-radius: 6px;
  border-left: 4px solid #8B4513;
}

.spec-label {
  font-weight: bold;
  color: #333;
  margin-bottom: 4px;
}

.spec-value {
  color: #666;
}

.rate-limit-warning {
  color: #856404;
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 4px;
  padding: 12px;
  margin: 10px 0;
}
```

  </style>
</head>
<body>

  <header>
    <h1>Thee Cigar Maestro</h1>
    <p class="subtitle">The Art. The Ritual. The Maestro.</p>
    <nav role="navigation" aria-label="Main navigation">
      <a href="index.html">Home</a>
      <a href="specs.html" class="active" aria-current="page">Specs</a>
      <a href="pairing.html">Pairing</a>
      <a href="education.html">Education</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="contact.html">Contact</a>
    </nav>
  </header>

  <main class="container">
    <section class="specs-engine">
      <h2>Search Verified Cigar Specs</h2>
      <p>Enter a cigar name to get official specs — length, ring gauge, strength, wrapper, binder, filler, tasting notes, and more.</p>

```
  <div class="search-container">
    <form id="spec-search-form" role="search" aria-label="Cigar specifications search">
      <div class="search-input-wrapper">
        <div style="position: relative; flex: 1;">
          <label for="cigar-search" class="sr-only">Enter cigar name</label>
          <input 
            type="text" 
            id="cigar-search"
            class="search-input"
            placeholder="e.g., Padron 1964 Anniversary Maduro" 
            aria-describedby="search-help search-status"
            autocomplete="off"
            maxlength="100"
            required 
          />
          <div id="autocomplete-dropdown" class="autocomplete-dropdown" role="listbox" aria-label="Cigar suggestions"></div>
        </div>
        <button type="submit" class="search-button" aria-label="Search for cigar specifications">
          <span class="loading-spinner" aria-hidden="true"></span>
          <span class="button-text">Search</span>
        </button>
      </div>
      <div id="search-help" class="sr-only">Enter a cigar name to search for its specifications including length, ring gauge, strength, and tasting notes</div>
    </form>
    
    <div id="search-status" class="sr-only" aria-live="polite"></div>
    
    <div id="spec-results" class="results-box" role="region" aria-label="Search results" aria-live="polite">
      <p class="placeholder-text">Search a cigar to see its official profile.</p>
    </div>
    
    <div id="search-history" class="search-history" style="display: none;">
      <h3>Recent Searches</h3>
      <div id="history-items"></div>
    </div>
  </div>
</section>
```

  </main>

  <footer>
    <p>© 2025 Thee Cigar Maestro. All rights reserved.<br>
    <a href="mailto:info@theecigarmaestro.com">info@theecigarmaestro.com</a></p>
  </footer>

  <script>
    // Enhanced Cigar Specs Search Implementation
    class CigarSpecsSearch {
      constructor() {
        this.form = document.getElementById('spec-search-form');
        this.input = document.getElementById('cigar-search');
        this.button = this.form.querySelector('.search-button');
        this.spinner = this.form.querySelector('.loading-spinner');
        this.buttonText = this.form.querySelector('.button-text');
        this.resultsBox = document.getElementById('spec-results');
        this.statusDiv = document.getElementById('search-status');
        this.autocompleteDiv = document.getElementById('autocomplete-dropdown');
        this.historyDiv = document.getElementById('search-history');
        this.historyItems = document.getElementById('history-items');
        
        // Configuration
        this.apiEndpoint = '/api/gpt';
        this.debounceDelay = 300;
        this.maxHistoryItems = 5;
        this.rateLimitDelay = 1000;
        this.maxInputLength = 100;
        
        // State
        this.searchTimeout = null;
        this.autocompleteTimeout = null;
        this.lastSearchTime = 0;
        this.searchHistory = this.loadSearchHistory();
        this.cache = new Map();
        this.selectedSuggestionIndex = -1;
        this.isLoading = false;
        
        this.init();
      }
      
      init() {
        this.setupEventListeners();
        this.renderSearchHistory();
        this.setupCSRFToken();
        this.setupOfflineDetection();
      }
      
      setupEventListeners() {
        // Form submission
        this.form.addEventListener('submit', (e) => this.handleSubmit(e));
        
        // Input events
        this.input.addEventListener('input', (e) => this.handleInput(e));
        this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
        this.input.addEventListener('blur', () => this.hideAutocomplete());
        this.input.addEventListener('focus', () => this.showRecentSuggestions());
        
        // Click outside to close autocomplete
        document.addEventListener('click', (e) => {
          if (!this.form.contains(e.target)) {
            this.hideAutocomplete();
          }
        });
        
        // History item clicks
        this.historyItems.addEventListener('click', (e) => {
          if (e.target.classList.contains('history-item')) {
            this.selectHistoryItem(e.target.textContent);
          }
        });
      }
      
      setupCSRFToken() {
        // Get CSRF token from meta tag or cookie
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                         this.getCookie('csrf-token');
        this.csrfToken = csrfToken;
      }
      
      setupOfflineDetection() {
        window.addEventListener('online', () => {
          this.showMessage('Connection restored. You can search again.', 'success');
        });
        
        window.addEventListener('offline', () => {
          this.showMessage('No internet connection. Please check your connection and try again.', 'error');
        });
      }
      
      async handleSubmit(e) {
        e.preventDefault();
        
        if (this.isLoading) return;
        
        const query = this.sanitizeInput(this.input.value.trim());
        
        if (!this.validateInput(query)) return;
        
        // Rate limiting
        const now = Date.now();
        if (now - this.lastSearchTime < this.rateLimitDelay) {
          this.showMessage('Please wait a moment before searching again.', 'warning');
          return;
        }
        
        this.lastSearchTime = now;
        this.hideAutocomplete();
        
        try {
          await this.performSearch(query);
        } catch (error) {
          this.handleError(error);
        }
      }
      
      handleInput(e) {
        const query = e.target.value.trim();
        
        // Clear previous timeout
        if (this.autocompleteTimeout) {
          clearTimeout(this.autocompleteTimeout);
        }
        
        // Remove error styling
        this.input.classList.remove('error');
        
        // Debounced autocomplete
        this.autocompleteTimeout = setTimeout(() => {
          if (query.length >= 2) {
            this.showAutocomplete(query);
          } else {
            this.hideAutocomplete();
          }
        }, this.debounceDelay);
      }
      
      handleKeydown(e) {
        const suggestions = this.autocompleteDiv.querySelectorAll('.autocomplete-item');
        
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            this.selectedSuggestionIndex = Math.min(this.selectedSuggestionIndex + 1, suggestions.length - 1);
            this.updateSuggestionSelection(suggestions);
            break;
            
          case 'ArrowUp':
            e.preventDefault();
            this.selectedSuggestionIndex = Math.max(this.selectedSuggestionIndex - 1, -1);
            this.updateSuggestionSelection(suggestions);
            break;
            
          case 'Enter':
            if (this.selectedSuggestionIndex >= 0 && suggestions[this.selectedSuggestionIndex]) {
              e.preventDefault();
              this.selectSuggestion(suggestions[this.selectedSuggestionIndex].textContent);
            }
            break;
            
          case 'Escape':
            this.hideAutocomplete();
            break;
        }
      }
      
      validateInput(query) {
        if (!query) {
          this.showMessage('Please enter a cigar name to search.', 'error');
          this.input.classList.add('error');
          this.input.focus();
          return false;
        }
        
        if (query.length > this.maxInputLength) {
          this.showMessage(`Search query is too long. Maximum ${this.maxInputLength} characters allowed.`, 'error');
          this.input.classList.add('error');
          return false;
        }
        
        // Basic XSS prevention
        if (this.containsScript(query)) {
          this.showMessage('Invalid characters detected in search query.', 'error');
          this.input.classList.add('error');
          return false;
        }
        
        return true;
      }
      
      sanitizeInput(input) {
        return input
          .replace(/[<>]/g, '') // Remove potential HTML tags
          .replace(/javascript:/gi, '') // Remove javascript: protocol
          .replace(/on\w+=/gi, '') // Remove event handlers
          .trim();
      }
      
      containsScript(input) {
        const scriptPatterns = [
          /<script/i,
          /javascript:/i,
          /on\w+=/i,
          /eval\(/i,
          /alert\(/i
        ];
        
        return scriptPatterns.some(pattern => pattern.test(input));
      }
      
      async performSearch(query) {
        // Check cache first
        const cacheKey = query.toLowerCase();
        if (this.cache.has(cacheKey)) {
          this.displayResults(this.cache.get(cacheKey), query);
          return;
        }
        
        this.setLoadingState(true);
        this.updateStatus('Searching for cigar specifications...');
        
        try {
          const response = await fetch(this.apiEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest',
              ...(this.csrfToken && { 'X-CSRF-Token': this.csrfToken })
            },
            body: JSON.stringify({ 
              prompt: query,
              type: 'cigar-specs',
              timestamp: Date.now()
            })
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          
          // Cache the result
          this.cache.set(cacheKey, data);
          
          // Add to search history
          this.addToHistory(query);
          
          this.displayResults(data, query);
          this.updateStatus(`Found specifications for ${query}`);
          
        } catch (error) {
          console.error('Search error:', error);
          this.handleError(error);
        } finally {
          this.setLoadingState(false);
        }
      }
      
      displayResults(data, query) {
        if (!data || !data.result) {
          this.showNoResults(query);
          return;
        }
        
        try {
          // Try to parse as JSON first for structured data
          const parsedData = JSON.parse(data.result);
          this.renderStructuredResults(parsedData, query);
        } catch (e) {
          // Fall back to plain text rendering
          this.renderPlainTextResults(data.result, query);
        }
      }
      
      renderStructuredResults(data, query) {
        const html = `
          <div class="spec-result">
            <h3>${this.escapeHtml(data.name || query)}</h3>
            <div class="spec-grid">
              ${data.length ? `<div class="spec-item"><div class="spec-label">Length:</div><div class="spec-value">${this.escapeHtml(data.length)}</div></div>` : ''}
              ${data.ring_gauge ? `<div class="spec-item"><div class="spec-label">Ring Gauge:</div><div class="spec-value">${this.escapeHtml(data.ring_gauge)}</div></div>` : ''}
              ${data.strength ? `<div class="spec-item"><div class="spec-label">Strength:</div><div class="spec-value">${this.escapeHtml(data.strength)}</div></div>` : ''}
              ${data.wrapper ? `<div class="spec-item"><div class="spec-label">Wrapper:</div><div class="spec-value">${this.escapeHtml(data.wrapper)}</div></div>` : ''}
              ${data.binder ? `<div class="spec-item"><div class="spec-label">Binder:</div><div class="spec-value">${this.escapeHtml(data.binder)}</div></div>` : ''}
              ${data.filler ? `<div class="spec-item"><div class="spec-label">Filler:</div><div class="spec-value">${this.escapeHtml(data.filler)}</div></div>` : ''}
            </div>
            ${data.tasting_notes ? `<div class="spec-item"><div class="spec-label">Tasting Notes:</div><div class="spec-value">${this.escapeHtml(data.tasting_notes)}</div></div>` : ''}
            ${data.description ? `<div class="spec-item"><div class="spec-label">Description:</div><div class="spec-value">${this.escapeHtml(data.description)}</div></div>` : ''}
          </div>
        `;
        
        this.resultsBox.innerHTML = html;
      }
      
      renderPlainTextResults(result, query) {
        const html = `
          <div class="spec-result">
            <h3>Specifications for "${this.escapeHtml(query)}"</h3>
            <pre>${this.escapeHtml(result)}</pre>

```
      </div>
    `;
    
    this.resultsBox.innerHTML = html;
  }
  
  showNoResults(query) {
    const html = `
      <div class="spec-result">
        <h3>No Results Found</h3>
        <p>Sorry, we couldn't find specifications for "${this.escapeHtml(query)}". Please try:</p>
        <ul>
          <li>Checking the spelling</li>
          <li>Using a different cigar name format</li>
          <li>Searching for the brand name only</li>
          <li>Trying alternative spellings</li>
        </ul>
      </div>
    `;
    
    this.resultsBox.innerHTML = html;
  }
  
  showAutocomplete(query) {
    // Mock autocomplete suggestions - in real app, this would come from API
    const suggestions = this.generateSuggestions(query);
    
    if (suggestions.length === 0) {
      this.hideAutocomplete();
      return;
    }
    
    const html = suggestions.map(suggestion => 
      `<div class="autocomplete-item" role="option">${this.escapeHtml(suggestion)}</div>`
    ).join('');
    
    this.autocompleteDiv.innerHTML = html;
    this.autocompleteDiv.style.display = 'block';
    this.selectedSuggestionIndex = -1;
    
    // Add click handlers
    this.autocompleteDiv.querySelectorAll('.autocomplete-item').forEach(item => {
      item.addEventListener('click', () => {
        this.selectSuggestion(item.textContent);
      });
    });
  }
  
  generateSuggestions(query) {
    // Mock cigar suggestions - in real app, this would come from API/database
    const mockSuggestions = [
      'Padron 1964 Anniversary Maduro',
      'Padron 1926 Serie',
      'Montecristo No. 2',
      'Cohiba Behike',
      'Arturo Fuente Opus X',
      'Davidoff Winston Churchill',
      'Romeo y Julieta Churchill',
      'Hoyo de Monterrey Epicure',
      'Partagas Serie D No. 4',
      'Bolivar Royal Corona'
    ];
    
    return mockSuggestions
      .filter(suggestion => 
        suggestion.toLowerCase().includes(query.toLowerCase())
      )
      .slice(0, 5);
  }
  
  showRecentSuggestions() {
    if (this.searchHistory.length > 0 && !this.input.value.trim()) {
      const html = this.searchHistory.slice(0, 3).map(item => 
        `<div class="autocomplete-item" role="option">${this.escapeHtml(item)}</div>`
      ).join('');
      
      this.autocompleteDiv.innerHTML = html;
      this.autocompleteDiv.style.display = 'block';
      
      // Add click handlers
      this.autocompleteDiv.querySelectorAll('.autocomplete-item').forEach(item => {
        item.addEventListener('click', () => {
          this.selectSuggestion(item.textContent);
        });
      });
    }
  }
  
  updateSuggestionSelection(suggestions) {
    suggestions.forEach((item, index) => {
      item.classList.toggle('selected', index === this.selectedSuggestionIndex);
    });
  }
  
  selectSuggestion(suggestion) {
    this.input.value = suggestion;
    this.hideAutocomplete();
    this.input.focus();
  }
  
  hideAutocomplete() {
    this.autocompleteDiv.style.display = 'none';
    this.selectedSuggestionIndex = -1;
  }
  
  addToHistory(query) {
    // Remove if already exists
    const index = this.searchHistory.indexOf(query);
    if (index > -1) {
      this.searchHistory.splice(index, 1);
    }
    
    // Add to beginning
    this.searchHistory.unshift(query);
    
    // Limit size
    if (this.searchHistory.length > this.maxHistoryItems) {
      this.searchHistory = this.searchHistory.slice(0, this.maxHistoryItems);
    }
    
    this.saveSearchHistory();
    this.renderSearchHistory();
  }
  
  renderSearchHistory() {
    if (this.searchHistory.length === 0) {
      this.historyDiv.style.display = 'none';
      return;
    }
    
    const html = this.searchHistory.map(item => 
      `<span class="history-item">${this.escapeHtml(item)}</span>`
    ).join('');
    
    this.historyItems.innerHTML = html;
    this.historyDiv.style.display = 'block';
  }
  
  selectHistoryItem(item) {
    this.input.value = item;
    this.input.focus();
    this.form.dispatchEvent(new Event('submit'));
  }
  
  loadSearchHistory() {
    try {
      const saved = localStorage.getItem('cigar-search-history');
      return saved ? JSON.parse(saved) : [];
    } catch (e) {
      console.warn('Failed to load search history:', e);
      return [];
    }
  }
  
  saveSearchHistory() {
    try {
      localStorage.setItem('cigar-search-history', JSON.stringify(this.searchHistory));
    } catch (e) {
      console.warn('Failed to save search history:', e);
    }
  }
  
  setLoadingState(loading) {
    this.isLoading = loading;
    this.button.disabled = loading;
    this.spinner.style.display = loading ? 'inline-block' : 'none';
    this.buttonText.textContent = loading ? 'Searching...' : 'Search';
    
    if (loading) {
      this.resultsBox.classList.add('loading');
      this.resultsBox.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center;">
          <div class="loading-spinner" style="display: inline-block; margin-right: 10px;"></div>
          <span>Searching cigar specifications...</span>
        </div>
      `;
    } else {
      this.resultsBox.classList.remove('loading');
    }
  }
  
  updateStatus(message) {
    this.statusDiv.textContent = message;
  }
  
  showMessage(message, type = 'info') {
    const className = `${type}-message`;
    const messageDiv = document.createElement('div');
    messageDiv.className = className;
    messageDiv.textContent = message;
    messageDiv.setAttribute('role', 'alert');
    
    // Insert after the search form
    this.form.parentNode.insertBefore(messageDiv, this.resultsBox);
    
    // Remove after 5 seconds
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.parentNode.removeChild(messageDiv);
      }
    }, 5000);
  }
  
  handleError(error) {
    console.error('Search error:', error);
    
    let message = 'An error occurred while searching. Please try again.';
    
    if (!navigator.onLine) {
      message = 'No internet connection. Please check your connection and try again.';
    } else if (error.message.includes('429')) {
      message = 'Too many requests. Please wait a moment and try again.';
    } else if (error.message.includes('500')) {
      message = 'Server error. Please try again later.';
    }
    
    this.showMessage(message, 'error');
    this.updateStatus('Search failed');
    
    this.resultsBox.innerHTML = `
      <div class="error-message">
        <strong>Search Failed</strong><br>
        ${this.escapeHtml(message)}
      </div>
    `;
  }
  
  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }
}

// Initialize the search functionality when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  new CigarSpecsSearch();
});

// Service Worker registration for offline support
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('SW registered: ', registration);
      })
      .catch(registrationError => {
        console.log('SW registration failed: ', registrationError);
      });
  });
}
```

  </script>

</body>
</html>
