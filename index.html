
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; media-src 'self' blob:; connect-src 'self' https://theecigarmaestro.vercel.app; worker-src 'self' blob:;" />
  <title>Thee Cigar Maestro ‚Äî Your Personal Cigar Journey</title>
  
  <!-- Progressive Web App Meta Tags -->
  <meta name="theme-color" content="#121212">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="assets/logos/logo-192.png">
  <link rel="manifest" href="/manifest.json">
  
  <!-- API Client and Authentication -->
  <script type="module" src="api-client.js"></script>
  <script type="module" src="auth-ui.js"></script>
  <script type="module" src="analytics-dashboard.js"></script>
  
  <!-- Improved Styles for Better UX -->
  <style>
    :root {
      --primary-bg: #121212;
      --secondary-bg: #1c1c1c;
      --accent-bg: #2c2c2c;
      --primary-text: #f0e6d2;
      --accent-text: #c69c6d;
      --secondary-text: #a67856;
      --border-color: #444;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --error-color: #dc3545;
      --header-height: 80px;
      --sidebar-width: 320px;
      --border-radius: 8px;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
    }

    body { 
      margin: 0; 
      background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
      overflow: hidden; 
      color: var(--primary-text); 
      font-family: Georgia, serif;
      line-height: 1.6;
    }

    /* Main Header Navigation */
    .main-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: rgba(28, 28, 28, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--accent-text);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      box-shadow: var(--shadow);
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-section h1 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--accent-text);
      font-weight: normal;
    }

    .main-nav {
      display: flex;
      gap: 2rem;
      align-items: center;
    }

    .nav-button {
      background: transparent;
      border: 2px solid transparent;
      color: var(--primary-text);
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .nav-button:hover {
      border-color: var(--accent-text);
      background: rgba(198, 156, 109, 0.1);
    }

    .nav-button.active {
      background: var(--accent-text);
      color: var(--primary-bg);
    }

    /* Authentication Section Styles */
    .auth-section {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-left: auto;
      padding-right: 1rem;
    }

    .auth-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .login-btn {
      background: rgba(198, 156, 109, 0.1);
      color: var(--accent-text);
      border: 1px solid var(--accent-text);
    }

    .login-btn:hover {
      background: var(--accent-text);
      color: var(--primary-bg);
    }

    .register-btn {
      background: linear-gradient(135deg, var(--accent-text) 0%, #d4af37 100%);
      color: var(--primary-bg);
    }

    .register-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(198, 156, 109, 0.3);
    }

    .logout-btn {
      background: rgba(220, 53, 69, 0.1);
      color: #ff6b6b;
      border: 1px solid #ff6b6b;
    }

    .logout-btn:hover {
      background: #ff6b6b;
      color: white;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .user-btn {
      background: rgba(198, 156, 109, 0.2);
      color: var(--accent-text);
      border: 1px solid var(--accent-text);
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .user-btn:hover {
      background: rgba(198, 156, 109, 0.3);
    }

         /* Mobile Menu Button */
     .mobile-menu-btn {
       display: none;
       background: transparent;
       border: none;
       color: var(--primary-text);
       font-size: 1.5rem;
       cursor: pointer;
       padding: 0.5rem;
       border-radius: var(--border-radius);
       transition: var(--transition);
     }

     .mobile-menu-btn:hover {
       background: rgba(198, 156, 109, 0.1);
       color: var(--accent-text);
     }

    /* Side Panel */
    .side-panel {
      position: fixed;
      top: var(--header-height);
      right: -var(--sidebar-width);
      width: var(--sidebar-width);
      height: calc(100vh - var(--header-height));
      background: rgba(28, 28, 28, 0.95);
      backdrop-filter: blur(10px);
      border-left: 1px solid var(--border-color);
      z-index: 999;
      transition: var(--transition);
      overflow-y: auto;
      box-shadow: var(--shadow);
    }

    .side-panel.open {
      right: 0;
    }

    .panel-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-content {
      padding: 1.5rem;
    }

    .close-panel {
      background: transparent;
      border: none;
      color: var(--primary-text);
      font-size: 1.5rem;
      cursor: pointer;
    }

    /* Main Canvas Area */
    .canvas-container {
      position: fixed;
      top: var(--header-height);
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }

    canvas { 
      display: block; 
      width: 100%;
      height: 100%;
    }

    /* Floating Controls */
    .floating-controls {
      position: fixed;
      bottom: 2rem;
      left: 2rem;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .control-group {
      background: rgba(28, 28, 28, 0.9);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 1rem;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
    }

    .control-group h3 {
      margin: 0 0 1rem 0;
      font-size: 1rem;
      color: var(--accent-text);
    }

    /* Filter Controls */
    .filter-options {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-option input[type="checkbox"] {
      accent-color: var(--accent-text);
    }

    .filter-option label {
      font-size: 0.9rem;
      cursor: pointer;
    }

    /* Info Display */
    .info-display {
      position: fixed;
      top: calc(var(--header-height) + 2rem);
      left: 2rem;
      background: rgba(28, 28, 28, 0.9);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      z-index: 100;
      max-width: 300px;
    }

    /* Modal Improvements */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 1500;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal-content {
      background: var(--secondary-bg);
      border-radius: var(--border-radius);
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-header h3 {
      margin: 0;
      color: var(--accent-text);
    }

    /* Quick Action Buttons */
    .quick-actions {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .action-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--accent-text);
      color: var(--primary-bg);
      border: none;
      cursor: pointer;
      font-size: 1.5rem;
      box-shadow: var(--shadow);
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .action-button:hover {
      transform: scale(1.1);
      background: #dab785;
    }

    /* Loading States */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(18, 18, 18, 0.8);
      backdrop-filter: blur(5px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .loading-content {
      text-align: center;
      color: var(--primary-text);
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 3px solid var(--border-color);
      border-top: 3px solid var(--accent-text);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .main-nav {
        display: none;
      }

      .mobile-menu-btn {
        display: block;
      }

      .side-panel {
        width: 100%;
        right: -100%;
      }

      .floating-controls {
        bottom: 1rem;
        left: 1rem;
      }

      .info-display {
        top: calc(var(--header-height) + 1rem);
        left: 1rem;
        right: 1rem;
        max-width: none;
      }

      .quick-actions {
        bottom: 1rem;
        right: 1rem;
      }

      .action-button {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
      }
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Focus styles for keyboard navigation */
    button:focus,
    input:focus,
    select:focus {
      outline: 2px solid var(--accent-text);
      outline-offset: 2px;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: calc(var(--header-height) + 1rem);
      right: 1rem;
      z-index: 1100;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      background: var(--secondary-bg);
      border-radius: var(--border-radius);
      padding: 1rem;
      border-left: 4px solid;
      box-shadow: var(--shadow);
      min-width: 300px;
      transform: translateX(100%);
      transition: var(--transition);
    }

    .toast.show {
      transform: translateX(0);
    }

         .toast.success { border-left-color: var(--success-color); }
     .toast.warning { border-left-color: var(--warning-color); }
     .toast.error { border-left-color: var(--error-color); }

     /* Enhanced Modal Content Styles */
     .cigar-details {
       display: flex;
       flex-direction: column;
       gap: 1.5rem;
     }

     .cigar-info h4 {
       margin: 0 0 0.5rem 0;
       color: var(--accent-text);
       font-size: 1.3rem;
     }

     .cigar-meta {
       display: flex;
       gap: 0.5rem;
       margin-bottom: 1rem;
     }

     .wrapper-badge,
     .strength-badge {
       padding: 0.25rem 0.75rem;
       border-radius: 20px;
       font-size: 0.8rem;
       font-weight: bold;
       background: var(--accent-text);
       color: var(--primary-bg);
     }

     .strength-badge {
       background: var(--secondary-text);
     }

     .flavor-profile,
     .pairing-suggestions {
       padding: 1rem;
       background: rgba(44, 44, 44, 0.5);
       border-radius: var(--border-radius);
       border-left: 3px solid var(--accent-text);
     }

     .flavor-profile h5,
     .pairing-suggestions h5 {
       margin: 0 0 0.75rem 0;
       color: var(--accent-text);
     }

     .pairing-grid {
       display: grid;
       grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
       gap: 0.5rem;
     }

     .pairing-item {
       padding: 0.5rem;
       background: rgba(198, 156, 109, 0.1);
       border-radius: 4px;
       text-align: center;
       font-size: 0.9rem;
     }

     .action-buttons {
       display: flex;
       gap: 0.75rem;
       flex-wrap: wrap;
       justify-content: center;
       margin-top: 1rem;
     }

     .action-btn {
       padding: 0.75rem 1.5rem;
       border: 2px solid var(--accent-text);
       background: transparent;
       color: var(--accent-text);
       border-radius: var(--border-radius);
       cursor: pointer;
       font-family: inherit;
       font-size: 0.9rem;
       transition: var(--transition);
       display: flex;
       align-items: center;
       gap: 0.5rem;
     }

     .action-btn:hover {
       background: var(--accent-text);
       color: var(--primary-bg);
     }

     .action-btn.primary {
       background: var(--accent-text);
       color: var(--primary-bg);
     }

     .action-btn.primary:hover {
       background: #dab785;
     }

     /* Section Content Styles */
     .section-content {
       padding: 1rem 0;
     }

     .section-content h4 {
       margin: 0 0 1rem 0;
       color: var(--accent-text);
       border-bottom: 2px solid var(--accent-text);
       padding-bottom: 0.5rem;
     }

     .action-list,
     .lesson-list,
     .journal-actions {
       display: flex;
       flex-direction: column;
       gap: 0.75rem;
       margin-top: 1rem;
     }

     .action-item,
     .lesson-item {
       padding: 1rem;
       background: rgba(44, 44, 44, 0.5);
       border-radius: var(--border-radius);
       border: 1px solid var(--border-color);
       cursor: pointer;
       transition: var(--transition);
       text-align: left;
       color: var(--primary-text);
     }

     .action-item:hover,
     .lesson-item:hover {
       background: rgba(198, 156, 109, 0.1);
       border-color: var(--accent-text);
     }

     .lesson-item h5 {
       margin: 0 0 0.5rem 0;
       color: var(--accent-text);
       font-size: 1rem;
     }

     .lesson-item p {
       margin: 0;
       font-size: 0.9rem;
       color: var(--secondary-text);
     }

     /* Search and Input Styles */
     .search-input,
     .pairing-search input {
       width: 100%;
       padding: 0.75rem;
       background: var(--accent-bg);
       border: 2px solid var(--border-color);
       border-radius: var(--border-radius);
       color: var(--primary-text);
       font-family: inherit;
       font-size: 1rem;
       transition: var(--transition);
     }

     .search-input:focus,
     .pairing-search input:focus {
       outline: none;
       border-color: var(--accent-text);
     }

     .search-btn {
       margin-top: 0.75rem;
       padding: 0.75rem 1.5rem;
       background: var(--accent-text);
       color: var(--primary-bg);
       border: none;
       border-radius: var(--border-radius);
       cursor: pointer;
       font-family: inherit;
       font-weight: bold;
       transition: var(--transition);
     }

     .search-btn:hover {
       background: #dab785;
     }

     .search-filters select {
       padding: 0.5rem;
       background: var(--accent-bg);
       border: 1px solid var(--border-color);
       border-radius: var(--border-radius);
       color: var(--primary-text);
       font-family: inherit;
       margin-top: 0.75rem;
       width: 100%;
     }

     /* Chat Interface Styles */
     .ai-chat-interface {
       display: flex;
       flex-direction: column;
       height: 400px;
     }

     .chat-messages {
       flex: 1;
       overflow-y: auto;
       padding: 1rem;
       background: rgba(44, 44, 44, 0.3);
       border-radius: var(--border-radius);
       margin-bottom: 1rem;
     }

     .message {
       margin-bottom: 1rem;
       padding: 0.75rem;
       border-radius: var(--border-radius);
     }

     .message.assistant {
       background: rgba(198, 156, 109, 0.1);
       border-left: 3px solid var(--accent-text);
     }

     .message.user {
       background: rgba(68, 68, 68, 0.5);
       border-left: 3px solid var(--secondary-text);
       margin-left: 2rem;
     }

     .chat-input {
       display: flex;
       gap: 0.75rem;
     }

     .chat-input input {
       flex: 1;
       padding: 0.75rem;
       background: var(--accent-bg);
       border: 2px solid var(--border-color);
       border-radius: var(--border-radius);
       color: var(--primary-text);
       font-family: inherit;
     }

     .chat-input button {
       padding: 0.75rem 1.5rem;
       background: var(--accent-text);
       color: var(--primary-bg);
       border: none;
       border-radius: var(--border-radius);
       cursor: pointer;
       font-family: inherit;
       font-weight: bold;
     }

     /* Help Content Styles */
     .help-content {
       max-height: 500px;
       overflow-y: auto;
     }

     .help-section {
       margin-bottom: 1.5rem;
       padding-bottom: 1rem;
       border-bottom: 1px solid var(--border-color);
     }

     .help-section:last-child {
       border-bottom: none;
     }

     .help-section h5 {
       margin: 0 0 0.75rem 0;
       color: var(--accent-text);
     }

     .help-section ul {
       margin: 0.5rem 0;
       padding-left: 1.5rem;
     }

     .help-section li {
       margin-bottom: 0.5rem;
       line-height: 1.5;
     }

     /* Mobile Responsive Improvements */
     @media (max-width: 768px) {
       .main-header {
         padding: 0 1rem;
       }

       .logo-section h1 {
         font-size: 1.2rem;
       }

       .main-nav {
         display: none;
       }

       .mobile-menu-btn {
         display: block;
         position: relative;
         z-index: 1001;
         transition: all 0.3s ease;
       }

       .mobile-menu-btn:focus-visible {
         outline: 2px solid var(--accent-color);
         outline-offset: 2px;
       }

       .side-panel {
         width: 100%;
         right: -100%;
         top: var(--header-height);
         transition: right 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
         z-index: 1000;
       }

       .side-panel.opening {
         right: -50%;
       }

       .side-panel.open {
         right: 0;
       }

       .side-panel.closing {
         right: -100%;
       }

       .floating-controls {
         bottom: 1rem;
         left: 1rem;
         right: 1rem;
       }

       .control-group {
         padding: 0.75rem;
       }

       .quick-actions {
         bottom: 1rem;
         right: 1rem;
         flex-direction: row;
         gap: 0.5rem;
       }

       .action-button {
         width: 50px;
         height: 50px;
         font-size: 1.2rem;
       }

       .info-display {
         left: 1rem;
         right: 1rem;
         max-width: none;
         top: calc(var(--header-height) + 1rem);
       }
     }

     @media (max-width: 480px) {
       .main-header {
         height: 60px;
         --header-height: 60px;
       }

       .logo-section h1 {
         font-size: 1rem;
       }

       .canvas-container {
         top: 60px;
       }

       .floating-controls {
         bottom: 0.5rem;
         left: 0.5rem;
         right: 0.5rem;
       }

       .quick-actions {
         bottom: 0.5rem;
         right: 0.5rem;
       }
     }

     /* Mobile Menu Backdrop and Animation Enhancements */
     .mobile-menu-backdrop {
       position: fixed;
       top: 0;
       left: 0;
       width: 100%;
       height: 100%;
       background: rgba(0, 0, 0, 0.5);
       z-index: 999;
       opacity: 0;
       transition: opacity 0.3s ease;
       pointer-events: none;
     }

     .mobile-menu-backdrop.visible {
       opacity: 1;
       pointer-events: auto;
     }

     /* Prevent scrolling when mobile menu is open */
     body.mobile-menu-open {
       overflow: hidden;
       position: fixed;
       width: 100%;
       height: 100%;
     }

     /* Enhanced focus management for mobile menu */
     @media (max-width: 768px) {
       .side-panel.open *:focus {
         outline: 2px solid var(--accent-color);
         outline-offset: 2px;
       }

       .side-panel {
         box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
       }

       .side-panel.open {
         box-shadow: -2px 0 16px rgba(0, 0, 0, 0.2);
       }
     }

     /* Smooth animations for mobile menu transitions */
     @media (prefers-reduced-motion: reduce) {
       .side-panel,
       .mobile-menu-backdrop,
       .mobile-menu-btn {
         transition: none !important;
       }
     }
   </style>
</head>
<body>
  <!-- Main Header -->
  <header class="main-header">
    <div class="logo-section">
      <h1>üö¨ Thee Cigar Maestro</h1>
    </div>
    
    <nav class="main-nav">
      <button class="nav-button active" data-section="explore">
        üåÄ Explore
      </button>
      <button class="nav-button" data-section="education">
        üìö Learn
      </button>
      <button class="nav-button" data-section="pairings">
        üç∑ Pairings
      </button>
      <button class="nav-button" data-section="journal">
        üìù Journal
      </button>
      <button class="nav-button" data-section="search">
        üîç Search
      </button>
      <button class="nav-button" onclick="window.analyticsDashboard?.show()">
        üìä Dashboard
      </button>
    </nav>

    <!-- User Authentication Section -->
    <div class="auth-section" id="authSection">
      <button class="auth-btn login-btn" id="loginBtn" onclick="window.authUI?.show('login')">
        üîê Sign In
      </button>
      <button class="auth-btn register-btn" id="registerBtn" onclick="window.authUI?.show('register')">
        ‚ú® Sign Up
      </button>
      <div class="user-menu" id="userMenu" style="display: none;">
        <button class="user-btn" id="userProfileBtn">
          <span id="userName">User</span>
        </button>
        <button class="auth-btn logout-btn" id="logoutBtn" onclick="window.authUI?.logout()">
          üö™ Logout
        </button>
      </div>
    </div>
    
    <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>
  </header>

  <!-- Side Panel for detailed controls -->
  <aside class="side-panel" id="sidePanel">
    <div class="panel-header">
      <h3 id="panelTitle">Explore Cigars</h3>
      <button class="close-panel" id="closePanelBtn">√ó</button>
    </div>
    <div class="panel-content" id="panelContent">
      <!-- Content will be dynamically loaded -->
    </div>
  </aside>

  <!-- Main Canvas Container -->
  <div class="canvas-container" id="canvasContainer">
    <!-- Three.js canvas will be inserted here -->
  </div>

  <!-- Info Display -->
  <div class="info-display" id="infoDisplay">
    <h4>üåÄ Welcome to Your Cigar Journey</h4>
    <p>Click on any cigar in the 3D space to learn more about its flavor profile, wrapper, and perfect pairings.</p>
    <div id="dynamicInfo">
      <small>Loading cigar data...</small>
    </div>
  </div>

  <!-- Floating Controls -->
  <div class="floating-controls">
    <div class="control-group">
      <h3>Filter by Wrapper</h3>
      <div class="filter-options" id="wrapperFilters">
        <div class="filter-option">
          <input type="checkbox" id="maduro" value="Maduro" checked>
          <label for="maduro">Maduro</label>
        </div>
        <div class="filter-option">
          <input type="checkbox" id="connecticut" value="Connecticut" checked>
          <label for="connecticut">Connecticut</label>
        </div>
        <div class="filter-option">
          <input type="checkbox" id="habano" value="Habano" checked>
          <label for="habano">Habano</label>
        </div>
        <div class="filter-option">
          <input type="checkbox" id="oscuro" value="Oscuro" checked>
          <label for="oscuro">Oscuro</label>
        </div>
        <div class="filter-option">
          <input type="checkbox" id="natural" value="Natural" checked>
          <label for="natural">Natural</label>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Action Buttons -->
  <div class="quick-actions">
    <button class="action-button" id="aiChatBtn" title="AI Assistant">ü§ñ</button>
    <button class="action-button" id="recordBtn" title="Record Tasting Notes">üéôÔ∏è</button>
    <button class="action-button" id="helpBtn" title="Help & Tour">‚ùì</button>
  </div>

  <!-- Modal Overlay -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Cigar Details</h3>
        <button class="close-panel" id="closeModalBtn">√ó</button>
      </div>
      <div id="modalContent">
        <!-- Modal content will be dynamically loaded -->
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p id="loadingMessage">Loading your cigar experience...</p>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Error Container for legacy support -->
  <div id="errorContainer"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js" integrity="sha384-gd3xd4QfbP7PiJPPr7dV3s6cXGJ0vy3S8xkW7YnK8eQMjB7c9PwSb0Rx9fF5J8P1" crossorigin="anonymous"></script>
  <script type="module">
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js';
    window.OrbitControls = OrbitControls;
  </script>
  <script type="module">
    // Import enhanced UI components
    import UIManager from './src/components/UIManager.js';
    import OnboardingTour from './src/components/OnboardingTour.js';
    import AdvancedControlsPanel from './src/components/AdvancedControlsPanel.js';
    import EnhancedCigarModal from './src/components/EnhancedCigarModal.js';
    import PersonalDashboard from './src/components/PersonalDashboard.js';
    
    // Initialize global UI manager and tour
    let uiManager;
    let onboardingTour;
    let advancedControls;
    let enhancedModal;
    let personalDashboard;
    
    // Enhanced Data Management System
    class DataManager {
      constructor() {
        this.data = {
          cigars: [],
          features: {},
          education: {},
          pairings: {},
          interface: {},
          meta: {},
          emotional: {},
          lounge: {},
          flavorAtlas: {},
          specs: {}
        };
        this.loaded = false;
      }

      async loadAllData() {
        const dataFiles = [
          { key: 'cigars', file: 'flavorverse_nodes.json' },
          { key: 'features', file: 'features.json' },
          { key: 'education', file: 'education.json' },
          { key: 'pairings', file: 'pairings.json' },
          { key: 'interface', file: 'interface.json' },
          { key: 'meta', file: 'meta.json' },
          { key: 'emotional', file: 'emotional.json' },
          { key: 'lounge', file: 'lounge.json' },
          { key: 'flavorAtlas', file: 'flavor-atlas.json' },
          { key: 'specs', file: 'cigar-specs.json' }
        ];

        try {
          const loadPromises = dataFiles.map(async ({ key, file }) => {
            try {
              const response = await fetch(file);
              if (!response.ok) {
                throw new Error(`Failed to load ${file}: ${response.status}`);
              }
              this.data[key] = await response.json();
              console.log(`‚úì Loaded ${file}`);
            } catch (error) {
              console.warn(`‚ö†Ô∏è Could not load ${file}:`, error.message);
              // Continue with partial data
            }
          });

          await Promise.all(loadPromises);
          this.loaded = true;
          console.log('üöÄ All data loaded successfully');
          return true;
        } catch (error) {
          console.error('‚ùå Critical error loading data:', error);
          showError('Failed to load application data');
          return false;
        }
      }

      getCigarPairings(cigarName) {
        if (!this.data.pairings.pairingEngineV3) {return [];}
        
        // Search for pairings based on wrapper type and flavor profile
        const cigar = this.data.cigars.find(c => c.name === cigarName);
        if (!cigar) {return [];}

        const pairings = [];
        const engine = this.data.pairings.pairingEngineV3;
        
        // Look for wrapper-based pairings
        if (engine.ceuLessons) {
          engine.ceuLessons.forEach(lesson => {
            if (lesson.focus && lesson.focus.includes(cigar.wrapper)) {
              pairings.push({
                type: 'Spirit Pairing',
                recommendation: lesson.lessonTitle,
                logic: lesson.learningObjective
              });
            }
          });
        }

        return pairings;
      }

      getEducationalContent(topic) {
        if (!this.data.education.educationTracks) {return [];}
        
        const tracks = this.data.education.educationTracks.tracks || [];
        return tracks.filter(track => 
          track.title.toLowerCase().includes(topic.toLowerCase()) ||
          track.lessons.some(lesson => lesson.toLowerCase().includes(topic.toLowerCase()))
        );
      }

      getEmotionalContext(wrapper) {
        if (!this.data.emotional.ritualFlows) {return null;}
        
        const flows = this.data.emotional.ritualFlows;
        const matchingFlow = Object.values(flows).find(flow => 
          flow.pairing && flow.pairing.toLowerCase().includes(wrapper.toLowerCase())
        );
        
        return matchingFlow || null;
      }

      getLoungeFeatures() {
        if (!this.data.lounge.loungeIntegrationTools) {return [];}
        
        const features = [];
        const tools = this.data.lounge.loungeIntegrationTools;
        
        if (tools.coreFunctions) {
          tools.coreFunctions.forEach(func => {
            features.push({
              name: func.replace('loungeIntegrationTools.', ''),
              status: tools.status,
              description: `${func} functionality`
            });
          });
        }
        
        return features;
      }
    }

    // Initialize data manager
    const dataManager = new DataManager();

    // Utility functions for security
    function sanitizeText(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showError(message) {
      const errorContainer = document.getElementById('errorContainer');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      errorContainer.appendChild(errorDiv);
      setTimeout(() => errorDiv.remove(), 5000);
    }

    function showSuccess(message) {
      const errorContainer = document.getElementById('errorContainer');
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.textContent = message;
      errorContainer.appendChild(successDiv);
      setTimeout(() => successDiv.remove(), 3000);
    }

    // Three.js scene variables
    let scene, camera, renderer, controls, geometry, raycaster, mouse;

    // Initialize Three.js scene
    async function init3DScene() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color("#121212");

      camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.z = 40;

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      document.body.appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      geometry = new THREE.SphereGeometry(1.2, 32, 32);
      raycaster = new THREE.Raycaster();
      mouse = new THREE.Vector2();

      // Add lighting
      const light = new THREE.PointLight(0xffffff, 1, 200);
      light.position.set(10, 10, 10);
      scene.add(light);

      const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
      scene.add(ambientLight);

      // Initialize global arrays
      window.stars = [];
      window.trails = [];
      window.cigarsInScene = [];

      // Make globally accessible
      window.scene = scene;
      window.camera = camera;
      window.renderer = renderer;
      window.controls = controls;
      window.geometry = geometry;
      window.raycaster = raycaster;
      window.mouse = mouse;
      
      // Setup mouse event listener
      window.addEventListener('mousemove', onMouseMove, false);
      
      // Start animation loop
      animate();
      
      console.log('üé® 3D Scene initialized successfully');
    }

    // UI Elements
    const info = document.getElementById("info");
    const modal = document.getElementById("modal");
    const educationPanel = document.getElementById("educationPanel");
    const pairingPanel = document.getElementById("pairingPanel");
    const loungePanel = document.getElementById("loungePanel");

    // Close button handlers
    document.getElementById("closeBtn").onclick = () => modal.style.display = "none";
    document.getElementById("closeEducationBtn").onclick = () => educationPanel.style.display = "none";
    document.getElementById("closePairingBtn").onclick = () => pairingPanel.style.display = "none";
    document.getElementById("closeLoungeBtn").onclick = () => loungePanel.style.display = "none";

    // Feature button handlers
    document.getElementById("educationBtn").onclick = () => showEducationPanel();
    document.getElementById("pairingBtn").onclick = () => showPairingPanel();
    document.getElementById("loungeBtn").onclick = () => showLoungePanel();
    document.getElementById("ritualBtn").onclick = () => startRitualMode();

    async function loadCigars() {
      if (!dataManager.loaded) {
        showError('Data not loaded yet. Please wait...');
        return;
      }

      try {
        const cigars = dataManager.data.cigars;
        const wrapperMap = {};

        cigars.forEach(item => {
          // Validate data structure
          if (!item.name || !item.wrapper || !item.color) {
            console.warn('Invalid cigar data:', item);
            return;
          }

          const mat = new THREE.MeshStandardMaterial({ color: item.color });
          const star = new THREE.Mesh(window.geometry, mat);
          star.position.set(
            Math.random() * 60 - 30,
            Math.random() * 60 - 30,
            Math.random() * 60 - 30
          );
          star.name = item.name;
          star.userData = { 
            wrapper: item.wrapper !== "Unknown" ? item.wrapper : "Not specified", 
            flavor: item.flavor !== "Undefined" ? item.flavor : "Flavor profile coming soon",
            originalData: item
          };
          window.scene.add(star);
          window.stars.push(star);
          window.cigarsInScene.push(star);

          // Cluster similar wrappers for trail drawing
          if (!wrapperMap[item.wrapper]) {wrapperMap[item.wrapper] = [];}
          wrapperMap[item.wrapper].push(star);
        });

        // Create ritual trails (glowing lines) for each wrapper cluster
        Object.values(wrapperMap).forEach(group => {
          if (group.length > 1) {
            for (let i = 0; i < group.length - 1; i++) {
              const material = new THREE.LineBasicMaterial({ color: 0xffd700, opacity: 0.6, transparent: true });
              const points = [group[i].position, group[i + 1].position];
              const geometry = new THREE.BufferGeometry().setFromPoints(points);
              const line = new THREE.Line(geometry, material);
              window.scene.add(line);
              window.trails.push(line);
            }
          }
        });

        showSuccess(`Loaded ${cigars.length} cigars into Thee Cigar Maestro`);
      } catch (error) {
        console.error('Error loading cigars:', error);
        showError('Failed to load cigar data. Please refresh the page.');
      }
    }

    // Enhanced modal functionality
    function showEnhancedModal(star) {
      const cigarName = star.name;
      const userData = star.userData;
      
      // Basic info
      document.getElementById("modalTitle").textContent = cigarName;
      document.getElementById("modalWrapper").textContent = userData.wrapper;
      document.getElementById("modalNotes").textContent = userData.flavor;
      
      // Pairings
      const pairings = dataManager.getCigarPairings(cigarName);
      const pairingsDiv = document.getElementById("modalPairings");
      if (pairings.length > 0) {
        pairingsDiv.innerHTML = `<h4>üç∑ Recommended Pairings:</h4>${  
      pairings.map(p => `<div class="pairing-item"><strong>${p.type}:</strong> ${p.recommendation}<br><em>${p.logic}</em></div>`).join('')}`;
      } else {
        pairingsDiv.innerHTML = '<h4>üç∑ Pairings:</h4><p>Pairing recommendations available in the Pairing Engine.</p>';
      }
      
      // Educational content
      const education = dataManager.getEducationalContent(userData.wrapper);
      const educationDiv = document.getElementById("modalEducation");
      if (education.length > 0) {
        educationDiv.innerHTML = `<h4>üìö Learn More:</h4>${  
      education.map(e => `<div class="lesson-item" onclick="openEducationTrack('${e.id}')">${e.title}</div>`).join('')}`;
      } else {
        educationDiv.innerHTML = '<h4>üìö Education:</h4><p>Educational content available in the Education panel.</p>';
      }
      
      // Emotional context
      const emotional = dataManager.getEmotionalContext(userData.wrapper);
      const emotionalDiv = document.getElementById("modalEmotional");
      if (emotional) {
        emotionalDiv.innerHTML = '<h4>üé≠ Ritual Context:</h4>' + 
          `<div class="emotional-trigger">Mood: ${emotional.mood} | Music: ${emotional.music}<br>` +
          `${emotional.memoryPrompt}</div>`;
      } else {
        emotionalDiv.innerHTML = '<h4>üé≠ Ritual:</h4><p>Start a ritual session to create emotional memories.</p>';
      }
      
      modal.style.display = "block";
    }

    function showEducationPanel() {
      const content = document.getElementById("educationContent");
      const education = dataManager.data.education;
      
      if (education.educationTracks && education.educationTracks.tracks) {
        const tracks = education.educationTracks.tracks;
        const ceuDiv = document.getElementById("ceuLessons");
        
        ceuDiv.innerHTML = `<h4>üìú CEU Certification Tracks:</h4>${ 
      tracks.map(track => 
        `<div class="lesson-item" onclick="startCEUTrack('${track.id}')">
          <strong>${track.title}</strong><br>
          <small>${track.objectives ? track.objectives.join(', ') : 'Professional development track'}</small>
        </div>`
      ).join('')}`;
      }
      
      educationPanel.style.display = "block";
    }

    function showPairingPanel() {
      const findBtn = document.getElementById("findPairingsBtn");
      const input = document.getElementById("pairingInput");
      const results = document.getElementById("pairingResults");
      
      findBtn.onclick = () => {
        const beverage = input.value.trim();
        if (!beverage) {
          showError('Please enter a beverage to find pairings');
          return;
        }
        
        // Simple pairing logic based on loaded data
        const pairings = dataManager.data.cigars.filter(cigar => {
          if (beverage.toLowerCase().includes('coffee') || beverage.toLowerCase().includes('espresso')) {
            return cigar.wrapper === 'Maduro' || cigar.flavor.toLowerCase().includes('chocolate');
          }
          if (beverage.toLowerCase().includes('whiskey') || beverage.toLowerCase().includes('bourbon')) {
            return cigar.wrapper === 'Habano' || cigar.flavor.toLowerCase().includes('spice');
          }
          if (beverage.toLowerCase().includes('wine') || beverage.toLowerCase().includes('red')) {
            return cigar.wrapper === 'Natural' || cigar.flavor.toLowerCase().includes('cedar');
          }
          return false;
        });
        
        if (pairings.length > 0) {
          results.innerHTML = `<h4>üéØ Perfect Matches:</h4>${ 
        pairings.map(cigar => 
          `<div class="pairing-item">
            <strong>${cigar.name}</strong><br>
            <em>${cigar.flavor}</em><br>
            <small>Wrapper: ${cigar.wrapper}</small>
          </div>`
        ).join('')}`;
        } else {
          results.innerHTML = '<p>No specific pairings found. Try different beverage types like coffee, whiskey, or wine.</p>';
        }
      };
      
      pairingPanel.style.display = "block";
    }

    function showLoungePanel() {
      const features = dataManager.getLoungeFeatures();
      const content = document.getElementById("loungeContent");
      
      const conciergeDiv = document.getElementById("conciergeMode");
      conciergeDiv.innerHTML = '<h4>üé© Concierge Services:</h4>' +
        '<div class="feature-button" onclick="activateConcierge()">Activate Personal Concierge</div>' +
        '<p>Your personal cigar advisor for premium selections and expert guidance.</p>';
      
      const featuresDiv = document.getElementById("loungeFeatures");
      featuresDiv.innerHTML = `<h4>üèõÔ∏è Lounge Features:</h4>${ 
    features.map(f => 
      `<div class="lesson-item">
        <strong>${f.name}</strong> (${f.status})<br>
        <small>${f.description}</small>
      </div>`
    ).join('')}`;
      
      loungePanel.style.display = "block";
    }

    function startRitualMode() {
      const emotional = dataManager.data.emotional;
      if (emotional.ritualFlows) {
        const flows = Object.keys(emotional.ritualFlows);
        const randomFlow = flows[Math.floor(Math.random() * flows.length)];
        const flow = emotional.ritualFlows[randomFlow];
        
        showSuccess(`üé≠ Ritual Mode: ${randomFlow.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
        
        // Show ritual guidance
        setTimeout(() => {
          alert(`üé≠ Ritual Guidance:\n\nMood: ${flow.mood}\nMusic: ${flow.music}\nLighting: ${flow.lightLevel}\n\nMemory Prompt: ${flow.memoryPrompt}`);
        }, 1000);
      } else {
        showError('Ritual data not available');
      }
    }

    // Placeholder functions for advanced features
    function startCEUTrack(trackId) {
      showSuccess(`Starting CEU track: ${trackId}`);
    }

    function openEducationTrack(trackId) {
      showEducationPanel();
      showSuccess(`Opening education track: ${trackId}`);
    }

    function activateConcierge() {
      showSuccess('üé© Personal Concierge activated. How may I assist you today?');
    }

    // Lighting is now handled in init3DScene function

    function onMouseMove(event) {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    }

    function animate() {
      requestAnimationFrame(animate);
      if (window.controls) window.controls.update();
      if (window.renderer && window.scene && window.camera) {
        window.renderer.render(window.scene, window.camera);
      }

      if (window.raycaster && window.mouse && window.camera && window.stars) {
        window.raycaster.setFromCamera(window.mouse, window.camera);
        const visibleStars = window.stars.filter(s => s.visible);
        const intersects = window.raycaster.intersectObjects(visibleStars);

              if (intersects.length > 0) {
          const info = document.getElementById("info");
          if (info) info.textContent = `‚≠ê ${intersects[0].object.name}`;
        } else {
          const info = document.getElementById("info");
          if (info) info.textContent = "üåÄ Thee Cigar Maestro ‚Äî Ritual Trail Viewer";
        }
      }
    }

    function updateFilter() {
      const selected = Array.from(document.querySelectorAll("#filter input:checked")).map(cb => cb.value);
      if (window.stars) {
        window.stars.forEach(star => {
          star.visible = selected.includes(star.userData.wrapper);
        });
      }
    }

    // Event listeners
    document.querySelectorAll("#filter input").forEach(cb => cb.addEventListener("change", updateFilter));
    
    window.addEventListener("click", (e) => {
      if (window.raycaster && window.mouse && window.camera && window.stars) {
        window.raycaster.setFromCamera(window.mouse, window.camera);
        const intersects = window.raycaster.intersectObjects(window.stars.filter(s => s.visible));
        if (intersects.length > 0) {
          const obj = intersects[0].object;
          showEnhancedModal(obj);
        }
      }
    });

    // Handle window resize
    window.addEventListener('resize', () => {
      if (window.camera && window.renderer) {
        window.camera.aspect = window.innerWidth / window.innerHeight;
        window.camera.updateProjectionMatrix();
        window.renderer.setSize(window.innerWidth, window.innerHeight);
      }
    });

    // Application initialization is handled in the DOMContentLoaded event handler

    // Application is now initialized through the DOMContentLoaded event handler above
  </script>

  <!-- Voice Recorder & Audio Playback -->
  <div id="voicePanel" style="position: absolute; bottom: 20px; left: 20px; z-index: 3; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #444; display: none;">
    <strong>üé§ Record Your Ritual</strong><br/>
    <button id="startRec">Start</button>
    <button id="stopRec">Stop</button>
    <audio id="playback" controls style="display:none; margin-top:5px;"></audio>
    <a id="downloadLink" download="ritual-memory.webm" style="display:none; color:#f0e6d2;">Download Memory</a>
  </div>

  <!-- GPT Chat Floating Button -->
  <button id="gptBtn" style="position:fixed;bottom:20px;right:20px;z-index:3;background:#5c4033;color:#f0e6d2;padding:10px 14px;border:none;border-radius:4px;cursor:pointer;">üß† Ask the Stars</button>

  <script>
    // Voice recording logic with proper error handling
    let mediaRecorder, audioChunks = [];
    const voicePanel = document.getElementById("voicePanel");
    const startBtn = document.getElementById("startRec");
    const stopBtn = document.getElementById("stopRec");
    const audio = document.getElementById("playback");
    const link = document.getElementById("downloadLink");

    startBtn.onclick = async () => {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Media recording not supported in this browser');
        }
        
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          audio.src = url;
          audio.style.display = 'block';
          link.href = url;
          link.style.display = 'inline';
          // Stop all tracks to release microphone
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (error) {
        console.error('Error starting recording:', error);
        showError('Failed to start recording. Please check your microphone permissions.');
      }
    };

    stopBtn.onclick = () => {
      try {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }
      } catch (error) {
        console.error('Error stopping recording:', error);
        showError('Error stopping recording.');
      }
    };

    // GPT assistant integration with improved error handling
    document.getElementById("gptBtn").onclick = () => {
      // Removed alert, implementing proper GPT integration
      const gptPanel = document.createElement('div');
      gptPanel.style.cssText = 'position:fixed;bottom:80px;right:20px;width:300px;background:#1e1e1e;color:#f0e6d2;border:1px solid #444;border-radius:8px;padding:1rem;z-index:999;';
      gptPanel.innerHTML = `
        <div style="font-weight:bold;margin-bottom:8px;">üß† Ask the Stars</div>
        <textarea id="gptInput" placeholder="Ask about pairings, rituals, cigars..." style="width:100%;height:60px;margin-bottom:8px;background:#2c2c2c;border:1px solid #666;color:#fff;padding:5px;"></textarea>
        <button id="gptSend" style="width:100%;padding:8px;background:#c69c6d;border:none;cursor:pointer;font-weight:bold;">Send</button>
        <button id="gptClose" style="float:right;background:transparent;border:none;color:#f0e6d2;cursor:pointer;">√ó</button>
        <div id="gptResponse" style="margin-top:10px;font-style:italic;">Ready to help with your cigar journey...</div>
      `;
      document.body.appendChild(gptPanel);

      document.getElementById('gptClose').onclick = () => gptPanel.remove();
      document.getElementById('gptSend').onclick = async () => {
        const input = document.getElementById('gptInput').value.trim();
        if (!input) {return;}

        const responseDiv = document.getElementById('gptResponse');
        responseDiv.textContent = "The Maestro is thinking...";

        try {
          // Input validation and sanitization
          if (input.length > 500) {
            throw new Error('Message too long. Please keep it under 500 characters.');
          }

          const res = await fetch("https://theecigarmaestro.vercel.app/api/gpt", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ prompt: sanitizeText(input) }),
            signal: AbortSignal.timeout(10000) // 10 second timeout
          });

          if (!res.ok) {
            throw new Error(`Server error: ${res.status}`);
          }

          const data = await res.json();
          if (data && data.response) {
            responseDiv.textContent = `üß† The Maestro says: ${data.response}`;
          } else {
            throw new Error('Invalid response format');
          }
        } catch (error) {
          console.error('GPT request error:', error);
          responseDiv.textContent = "‚ö†Ô∏è Unable to reach The Maestro. Please try again later.";
        }
      };
    };

    // Trigger voice panel on star click
    window.addEventListener("click", (e) => {
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(stars.filter(s => s.visible));
      if (intersects.length > 0) {
        voicePanel.style.display = "block";
      }
    });
  </script>
  
  <!-- Enhanced Feature Scripts -->
  <script type="module" src="local-storage-manager.js"></script>
  <script type="module" src="advanced-search.js"></script>
  <script type="module" src="analytics-integration.js"></script>
  <script type="module" src="ui-enhancements.js"></script>
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js');
          console.log('‚úÖ Service Worker registered successfully:', registration.scope);
          
          // Listen for service worker messages
          navigator.serviceWorker.addEventListener('message', (event) => {
            const { type, action } = event.data;
            
            if (type === 'SYNC_REQUEST') {
              if (action === 'user-data' && window.storageManager) {
                // Sync user data when requested
                window.storageManager.saveData();
                console.log('üì§ User data synced');
              }
              
              if (action === 'analytics' && window.storageManager) {
                // Sync analytics when requested
                const analytics = window.storageManager.exportData().analytics;
                console.log('üìä Analytics synced:', analytics);
              }
            }
          });
          
          // Register for background sync
          if ('sync' in window.ServiceWorkerRegistration.prototype) {
            registration.sync.register('sync-user-data');
            registration.sync.register('sync-analytics');
          }
          
        } catch (error) {
          console.error('‚ùå Service Worker registration failed:', error);
        }
      });
    }

    // Authentication State Management
    function setupAuthStateManager() {
      // Listen for authentication state changes
      window.addEventListener('authStateChange', (event) => {
        const { user, isAuthenticated } = event.detail;
        updateAuthUI(isAuthenticated, user);
      });

      // Check initial auth state
      const user = window.CigarMaestroAPI?.getCurrentUser();
      if (user) {
        updateAuthUI(true, user);
      }
    }

    function updateAuthUI(isAuthenticated, user = null) {
      const loginBtn = document.getElementById('loginBtn');
      const registerBtn = document.getElementById('registerBtn');
      const userMenu = document.getElementById('userMenu');
      const userName = document.getElementById('userName');

      if (isAuthenticated && user) {
        // Show user menu, hide auth buttons
        loginBtn.style.display = 'none';
        registerBtn.style.display = 'none';
        userMenu.style.display = 'flex';
        userName.textContent = user.name || user.email;
        
        // Track authentication event
        window.CigarMaestroAPI?.trackEvent('user_authenticated', {
          userId: user.id,
          userEmail: user.email
        });
      } else {
        // Show auth buttons, hide user menu
        loginBtn.style.display = 'flex';
        registerBtn.style.display = 'flex';
        userMenu.style.display = 'none';
      }
    }

    // Initialize the enhanced UI system
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Initialize authentication state management
        setupAuthStateManager();
        
        // Initialize UI Manager
        uiManager = new UIManager();
        window.uiManager = uiManager; // Make globally accessible for legacy code
        
        // Initialize onboarding tour
        onboardingTour = new OnboardingTour(uiManager);
        window.onboardingTour = onboardingTour; // Make globally accessible
        
        // Initialize data manager
        const dataManager = new DataManager();
        await dataManager.loadAllData();
        window.dataManager = dataManager; // Make globally accessible
        
        // Initialize advanced components
        advancedControls = new AdvancedControlsPanel(uiManager, dataManager);
        enhancedModal = new EnhancedCigarModal(uiManager, dataManager);
        personalDashboard = new PersonalDashboard(uiManager, dataManager);
        
        // Make components globally accessible
        window.advancedControls = advancedControls;
        window.enhancedModal = enhancedModal;
        window.personalDashboard = personalDashboard;
        
        // Initialize 3D scene
        uiManager.showLoading('Loading 3D visualization...');
        await init3DScene();
        uiManager.hideLoading();
        
        // Load cigars into the scene
        uiManager.showLoading('Loading cigar data...');
        await loadCigars();
        uiManager.hideLoading();
        
        // Show welcome message
        uiManager.showToast('Welcome to Thee Cigar Maestro! üö¨', 'success', 5000);
        
        // Start onboarding tour for first-time users
        if (OnboardingTour.shouldShowTour()) {
          setTimeout(() => {
            onboardingTour.start();
          }, 2000); // Give UI time to settle
        }
        
        // Setup event listeners for UI integration
        setupUIIntegration();
        
        console.log('üéâ Application fully initialized');
        
      } catch (error) {
        console.error('‚ùå Failed to initialize application:', error);
        uiManager?.showToast('Failed to load application. Please refresh.', 'error', 10000);
      }
    });

    // Setup integration between UI and existing functionality
    function setupUIIntegration() {
      // Listen for filter changes from UI
      document.addEventListener('filterChange', (event) => {
        const { wrapper, checked } = event.detail;
        updateCigarVisibility(wrapper, checked);
      });
      
      // Listen for random cigar selection
      document.addEventListener('randomCigar', () => {
        selectRandomCigar();
      });
      
      // Setup 3D scene click handling with improved modal
      window.addEventListener('cigarSelected', (event) => {
        const { cigar } = event.detail;
        showEnhancedModalWithUI(cigar);
      });
    }

    // Enhanced modal function that uses the new UI system
    function showEnhancedModalWithUI(star) {
      const cigarName = star.name;
      const userData = star.userData;
      
      const content = `
        <div class="cigar-details">
          <div class="cigar-info">
            <h4>${cigarName}</h4>
            <div class="cigar-meta">
              <span class="wrapper-badge">${userData.wrapper}</span>
              <span class="strength-badge">Medium</span>
            </div>
          </div>
          
          <div class="flavor-profile">
            <h5>üåø Flavor Profile</h5>
            <p>${userData.flavor}</p>
          </div>
          
          <div class="pairing-suggestions">
            <h5>üç∑ Perfect Pairings</h5>
            <div class="pairing-grid">
              <div class="pairing-item">‚òï Dark Roast Coffee</div>
              <div class="pairing-item">ü•É Single Malt Whisky</div>
              <div class="pairing-item">üç∑ Bold Red Wine</div>
            </div>
          </div>
          
          <div class="action-buttons">
            <button onclick="uiManager.navigateToSection('journal')" class="action-btn">
              üìù Add to Journal
            </button>
            <button onclick="uiManager.navigateToSection('pairings')" class="action-btn">
              üç∑ Find Pairings
            </button>
            <button onclick="startTastingSession('${cigarName}')" class="action-btn primary">
              üé≠ Start Tasting Session
            </button>
          </div>
        </div>
      `;
      
      uiManager.showModal(`üö¨ ${cigarName}`, content);
    }

    // Utility functions for the new UI
    function updateCigarVisibility(wrapper, checked) {
      // Filter cigars in 3D scene based on wrapper type
      if (window.cigarsInScene) {
        window.cigarsInScene.forEach(cigar => {
          if (cigar.userData.wrapper === wrapper) {
            cigar.visible = checked;
          }
        });
      }
    }

    function selectRandomCigar() {
      if (window.cigarsInScene && window.cigarsInScene.length > 0) {
        const randomIndex = Math.floor(Math.random() * window.cigarsInScene.length);
        const randomCigar = window.cigarsInScene[randomIndex];
        
        // Animate camera to cigar
        if (window.controls && window.camera) {
          window.controls.target.copy(randomCigar.position);
          window.camera.position.set(
            randomCigar.position.x + 10,
            randomCigar.position.y + 10,
            randomCigar.position.z + 10
          );
          window.controls.update();
        }
        
        // Show cigar details
        showEnhancedModalWithUI(randomCigar);
      }
    }

    function startTastingSession(cigarName) {
      uiManager.closeModal();
      uiManager.navigateToSection('journal');
      uiManager.showToast(`Starting tasting session for ${cigarName}`, 'success');
    }

  </script>
</body>
</html>
