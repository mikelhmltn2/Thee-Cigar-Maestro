
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; media-src 'self' blob:; connect-src 'self' https://theecigarmaestro.vercel.app;" />
  <title>Flavorverse ‚Äî Ritual Trail Interface</title>
  
  <!-- Progressive Web App Meta Tags -->
  <meta name="theme-color" content="#121212">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="/assets/manifest-BLP33nyO.json">
  <style>
    body { margin: 0; background-color: #121212; overflow: hidden; color: #f0e6d2; font-family: Georgia, serif; }
    canvas { display: block; }
    #info, #filter, #modal, #educationPanel, #pairingPanel, #loungePanel {
      position: absolute;
      z-index: 2;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #444;
      padding: 10px;
      color: #f0e6d2;
    }
    #info { top: 20px; left: 20px; font-size: 16px; }
    #filter { top: 20px; right: 20px; font-size: 14px; }
    #modal {
      display: none;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      width: 400px;
      max-height: 70vh;
      overflow-y: auto;
    }
    #educationPanel {
      display: none;
      top: 100px;
      right: 20px;
      width: 300px;
      max-height: 70vh;
      overflow-y: auto;
    }
    #pairingPanel {
      display: none;
      bottom: 100px;
      left: 20px;
      width: 350px;
      max-height: 50vh;
      overflow-y: auto;
    }
    #loungePanel {
      display: none;
      bottom: 100px;
      right: 20px;
      width: 300px;
      max-height: 50vh;
      overflow-y: auto;
    }
    #modal h3, #educationPanel h3, #pairingPanel h3, #loungePanel h3 { margin-top: 0; }
    .close-btn {
      background: #5c4033;
      border: none;
      color: white;
      padding: 4px 8px;
      float: right;
      cursor: pointer;
      border-radius: 3px;
    }
    .error-message {
      background: rgba(220, 20, 60, 0.8);
      color: white;
      padding: 10px;
      border-radius: 4px;
      margin: 5px 0;
    }
    .success-message {
      background: rgba(0, 128, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 4px;
      margin: 5px 0;
    }
    .feature-button {
      background: #c69c6d;
      border: none;
      color: #121212;
      padding: 8px 12px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .feature-button:hover {
      background: #dab785;
    }
    .pairing-item {
      background: rgba(92, 64, 51, 0.3);
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      border-left: 3px solid #c69c6d;
    }
    .lesson-item {
      background: rgba(60, 60, 60, 0.5);
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      cursor: pointer;
    }
    .lesson-item:hover {
      background: rgba(92, 64, 51, 0.5);
    }
    .emotional-trigger {
      background: linear-gradient(45deg, #3a2c20, #5c4033);
      padding: 6px;
      margin: 3px 0;
      border-radius: 3px;
      font-size: 12px;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
  </style>
  <script type="module" crossorigin src="/assets/main-BxMkerj5.js"></script>
<link rel="manifest" href="/manifest.webmanifest"><script id="vite-plugin-pwa:register-sw" src="/registerSW.js"></script></head>
<body>
  <div id="info">üåÄ Flavorverse ‚Äî Ritual Trail Viewer</div>
  
  <!-- Feature Navigation Buttons -->
  <div style="position: absolute; top: 70px; left: 20px; z-index: 3;">
    <button class="feature-button" id="educationBtn">üìö Education</button>
    <button class="feature-button" id="pairingBtn">üç∑ Pairings</button>
    <button class="feature-button" id="loungeBtn">üèõÔ∏è Lounge</button>
    <button class="feature-button" id="ritualBtn">üé≠ Ritual</button>
  </div>
  
  <div id="filter">
    <strong>Filter by Wrapper</strong><br/>
    <label><input type="checkbox" value="Maduro" checked /> Maduro</label>
    <label><input type="checkbox" value="Connecticut" checked /> Connecticut</label>
    <label><input type="checkbox" value="Habano" checked /> Habano</label>
    <label><input type="checkbox" value="Oscuro" checked /> Oscuro</label>
    <label><input type="checkbox" value="Natural" checked /> Natural</label>
  </div>
  
  <!-- Enhanced Modal with Rich Content -->
  <div id="modal">
    <button class="close-btn" id="closeBtn">√ó</button>
    <h3 id="modalTitle">Cigar Name</h3>
    <div id="modalContent">
      <p><strong>Wrapper:</strong> <span id="modalWrapper"></span></p>
      <p><strong>Flavor Profile:</strong> <span id="modalNotes"></span></p>
      <div id="modalPairings"></div>
      <div id="modalEducation"></div>
      <div id="modalEmotional"></div>
    </div>
  </div>

  <!-- Education Panel -->
  <div id="educationPanel">
    <button class="close-btn" id="closeEducationBtn">√ó</button>
    <h3>üìö Educational Content</h3>
    <div id="educationContent">
      <div id="ceuLessons"></div>
      <div id="certificationTracks"></div>
    </div>
  </div>

  <!-- Pairing Panel -->
  <div id="pairingPanel">
    <button class="close-btn" id="closePairingBtn">√ó</button>
    <h3>üç∑ Pairing Engine</h3>
    <div id="pairingContent">
      <input type="text" id="pairingInput" placeholder="Enter beverage (e.g., espresso, whiskey)..." style="width: 100%; margin-bottom: 10px; padding: 5px; background: #2c2c2c; border: 1px solid #666; color: #f0e6d2;" />
      <button class="feature-button" id="findPairingsBtn">Find Pairings</button>
      <div id="pairingResults"></div>
    </div>
  </div>

  <!-- Lounge Panel -->
  <div id="loungePanel">
    <button class="close-btn" id="closeLoungeBtn">√ó</button>
    <h3>üèõÔ∏è Lounge Experience</h3>
    <div id="loungeContent">
      <div id="conciergeMode"></div>
      <div id="loungeFeatures"></div>
    </div>
  </div>

  <div id="errorContainer"></div>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js" integrity="sha384-gd3xd4QfbP7PiJPPr7dV3s6cXGJ0vy3S8xkW7YnK8eQMjB7c9PwSb0Rx9fF5J8P1" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js" integrity="sha384-KfY7P2q4L6T8wHj9nQr0N9p3K4L5M8B3J6Q1W7S4R2F9G8H5I6J7K8L9M0N1O2P3" crossorigin="anonymous"></script>
  <script>
    // Enhanced Data Management System
    class DataManager {
      constructor() {
        this.data = {
          cigars: [],
          features: {},
          education: {},
          pairings: {},
          interface: {},
          meta: {},
          emotional: {},
          lounge: {},
          flavorAtlas: {},
          specs: {}
        };
        this.loaded = false;
      }

      async loadAllData() {
        const dataFiles = [
          { key: 'cigars', file: 'flavorverse_nodes.json' },
          { key: 'features', file: 'features.json' },
          { key: 'education', file: 'education.json' },
          { key: 'pairings', file: 'pairings.json' },
          { key: 'interface', file: 'interface.json' },
          { key: 'meta', file: 'meta.json' },
          { key: 'emotional', file: 'emotional.json' },
          { key: 'lounge', file: 'lounge.json' },
          { key: 'flavorAtlas', file: 'flavor-atlas.json' },
          { key: 'specs', file: 'cigar-specs.json' }
        ];

        try {
          const loadPromises = dataFiles.map(async ({ key, file }) => {
            try {
              const response = await fetch(file);
              if (!response.ok) {
                throw new Error(`Failed to load ${file}: ${response.status}`);
              }
              this.data[key] = await response.json();
              console.log(`‚úì Loaded ${file}`);
            } catch (error) {
              console.warn(`‚ö†Ô∏è Could not load ${file}:`, error.message);
              // Continue with partial data
            }
          });

          await Promise.all(loadPromises);
          this.loaded = true;
          console.log('üöÄ All data loaded successfully');
          return true;
        } catch (error) {
          console.error('‚ùå Critical error loading data:', error);
          showError('Failed to load application data');
          return false;
        }
      }

      getCigarPairings(cigarName) {
        if (!this.data.pairings.pairingEngineV3) {return [];}
        
        // Search for pairings based on wrapper type and flavor profile
        const cigar = this.data.cigars.find(c => c.name === cigarName);
        if (!cigar) {return [];}

        const pairings = [];
        const engine = this.data.pairings.pairingEngineV3;
        
        // Look for wrapper-based pairings
        if (engine.ceuLessons) {
          engine.ceuLessons.forEach(lesson => {
            if (lesson.focus && lesson.focus.includes(cigar.wrapper)) {
              pairings.push({
                type: 'Spirit Pairing',
                recommendation: lesson.lessonTitle,
                logic: lesson.learningObjective
              });
            }
          });
        }

        return pairings;
      }

      getEducationalContent(topic) {
        if (!this.data.education.educationTracks) {return [];}
        
        const tracks = this.data.education.educationTracks.tracks || [];
        return tracks.filter(track => 
          track.title.toLowerCase().includes(topic.toLowerCase()) ||
          track.lessons.some(lesson => lesson.toLowerCase().includes(topic.toLowerCase()))
        );
      }

      getEmotionalContext(wrapper) {
        if (!this.data.emotional.ritualFlows) {return null;}
        
        const flows = this.data.emotional.ritualFlows;
        const matchingFlow = Object.values(flows).find(flow => 
          flow.pairing && flow.pairing.toLowerCase().includes(wrapper.toLowerCase())
        );
        
        return matchingFlow || null;
      }

      getLoungeFeatures() {
        if (!this.data.lounge.loungeIntegrationTools) {return [];}
        
        const features = [];
        const tools = this.data.lounge.loungeIntegrationTools;
        
        if (tools.coreFunctions) {
          tools.coreFunctions.forEach(func => {
            features.push({
              name: func.replace('loungeIntegrationTools.', ''),
              status: tools.status,
              description: `${func} functionality`
            });
          });
        }
        
        return features;
      }
    }

    // Initialize data manager
    const dataManager = new DataManager();

    // Utility functions for security
    function sanitizeText(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showError(message) {
      const errorContainer = document.getElementById('errorContainer');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      errorContainer.appendChild(errorDiv);
      setTimeout(() => errorDiv.remove(), 5000);
    }

    function showSuccess(message) {
      const errorContainer = document.getElementById('errorContainer');
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.textContent = message;
      errorContainer.appendChild(successDiv);
      setTimeout(() => successDiv.remove(), 3000);
    }

    // Initialize Three.js scene
    const scene = new THREE.Scene();
    scene.background = new THREE.Color("#121212");

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 40;

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    const geometry = new THREE.SphereGeometry(1.2, 32, 32);
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    const stars = [];
    const trails = [];

    // UI Elements
    const info = document.getElementById("info");
    const modal = document.getElementById("modal");
    const educationPanel = document.getElementById("educationPanel");
    const pairingPanel = document.getElementById("pairingPanel");
    const loungePanel = document.getElementById("loungePanel");

    // Close button handlers
    document.getElementById("closeBtn").onclick = () => modal.style.display = "none";
    document.getElementById("closeEducationBtn").onclick = () => educationPanel.style.display = "none";
    document.getElementById("closePairingBtn").onclick = () => pairingPanel.style.display = "none";
    document.getElementById("closeLoungeBtn").onclick = () => loungePanel.style.display = "none";

    // Feature button handlers
    document.getElementById("educationBtn").onclick = () => showEducationPanel();
    document.getElementById("pairingBtn").onclick = () => showPairingPanel();
    document.getElementById("loungeBtn").onclick = () => showLoungePanel();
    document.getElementById("ritualBtn").onclick = () => startRitualMode();

    async function loadCigars() {
      if (!dataManager.loaded) {
        showError('Data not loaded yet. Please wait...');
        return;
      }

      try {
        const cigars = dataManager.data.cigars;
        const wrapperMap = {};

        cigars.forEach(item => {
          // Validate data structure
          if (!item.name || !item.wrapper || !item.color) {
            console.warn('Invalid cigar data:', item);
            return;
          }

          const mat = new THREE.MeshStandardMaterial({ color: item.color });
          const star = new THREE.Mesh(geometry, mat);
          star.position.set(
            Math.random() * 60 - 30,
            Math.random() * 60 - 30,
            Math.random() * 60 - 30
          );
          star.name = item.name;
          star.userData = { 
            wrapper: item.wrapper !== "Unknown" ? item.wrapper : "Not specified", 
            flavor: item.flavor !== "Undefined" ? item.flavor : "Flavor profile coming soon",
            originalData: item
          };
          scene.add(star);
          stars.push(star);

          // Cluster similar wrappers for trail drawing
          if (!wrapperMap[item.wrapper]) {wrapperMap[item.wrapper] = [];}
          wrapperMap[item.wrapper].push(star);
        });

        // Create ritual trails (glowing lines) for each wrapper cluster
        Object.values(wrapperMap).forEach(group => {
          if (group.length > 1) {
            for (let i = 0; i < group.length - 1; i++) {
              const material = new THREE.LineBasicMaterial({ color: 0xffd700, opacity: 0.6, transparent: true });
              const points = [group[i].position, group[i + 1].position];
              const geometry = new THREE.BufferGeometry().setFromPoints(points);
              const line = new THREE.Line(geometry, material);
              scene.add(line);
              trails.push(line);
            }
          }
        });

        showSuccess(`Loaded ${cigars.length} cigars into the Flavorverse`);
      } catch (error) {
        console.error('Error loading cigars:', error);
        showError('Failed to load cigar data. Please refresh the page.');
      }
    }

    // Enhanced modal functionality
    function showEnhancedModal(star) {
      const cigarName = star.name;
      const userData = star.userData;
      
      // Basic info
      document.getElementById("modalTitle").textContent = cigarName;
      document.getElementById("modalWrapper").textContent = userData.wrapper;
      document.getElementById("modalNotes").textContent = userData.flavor;
      
      // Pairings
      const pairings = dataManager.getCigarPairings(cigarName);
      const pairingsDiv = document.getElementById("modalPairings");
      if (pairings.length > 0) {
        pairingsDiv.innerHTML = `<h4>üç∑ Recommended Pairings:</h4>${  
      pairings.map(p => `<div class="pairing-item"><strong>${p.type}:</strong> ${p.recommendation}<br><em>${p.logic}</em></div>`).join('')}`;
      } else {
        pairingsDiv.innerHTML = '<h4>üç∑ Pairings:</h4><p>Pairing recommendations available in the Pairing Engine.</p>';
      }
      
      // Educational content
      const education = dataManager.getEducationalContent(userData.wrapper);
      const educationDiv = document.getElementById("modalEducation");
      if (education.length > 0) {
        educationDiv.innerHTML = `<h4>üìö Learn More:</h4>${  
      education.map(e => `<div class="lesson-item" onclick="openEducationTrack('${e.id}')">${e.title}</div>`).join('')}`;
      } else {
        educationDiv.innerHTML = '<h4>üìö Education:</h4><p>Educational content available in the Education panel.</p>';
      }
      
      // Emotional context
      const emotional = dataManager.getEmotionalContext(userData.wrapper);
      const emotionalDiv = document.getElementById("modalEmotional");
      if (emotional) {
        emotionalDiv.innerHTML = '<h4>üé≠ Ritual Context:</h4>' + 
          `<div class="emotional-trigger">Mood: ${emotional.mood} | Music: ${emotional.music}<br>` +
          `${emotional.memoryPrompt}</div>`;
      } else {
        emotionalDiv.innerHTML = '<h4>üé≠ Ritual:</h4><p>Start a ritual session to create emotional memories.</p>';
      }
      
      modal.style.display = "block";
    }

    function showEducationPanel() {
      const content = document.getElementById("educationContent");
      const education = dataManager.data.education;
      
      if (education.educationTracks && education.educationTracks.tracks) {
        const tracks = education.educationTracks.tracks;
        const ceuDiv = document.getElementById("ceuLessons");
        
        ceuDiv.innerHTML = `<h4>üìú CEU Certification Tracks:</h4>${ 
      tracks.map(track => 
        `<div class="lesson-item" onclick="startCEUTrack('${track.id}')">
          <strong>${track.title}</strong><br>
          <small>${track.objectives ? track.objectives.join(', ') : 'Professional development track'}</small>
        </div>`
      ).join('')}`;
      }
      
      educationPanel.style.display = "block";
    }

    function showPairingPanel() {
      const findBtn = document.getElementById("findPairingsBtn");
      const input = document.getElementById("pairingInput");
      const results = document.getElementById("pairingResults");
      
      findBtn.onclick = () => {
        const beverage = input.value.trim();
        if (!beverage) {
          showError('Please enter a beverage to find pairings');
          return;
        }
        
        // Simple pairing logic based on loaded data
        const pairings = dataManager.data.cigars.filter(cigar => {
          if (beverage.toLowerCase().includes('coffee') || beverage.toLowerCase().includes('espresso')) {
            return cigar.wrapper === 'Maduro' || cigar.flavor.toLowerCase().includes('chocolate');
          }
          if (beverage.toLowerCase().includes('whiskey') || beverage.toLowerCase().includes('bourbon')) {
            return cigar.wrapper === 'Habano' || cigar.flavor.toLowerCase().includes('spice');
          }
          if (beverage.toLowerCase().includes('wine') || beverage.toLowerCase().includes('red')) {
            return cigar.wrapper === 'Natural' || cigar.flavor.toLowerCase().includes('cedar');
          }
          return false;
        });
        
        if (pairings.length > 0) {
          results.innerHTML = `<h4>üéØ Perfect Matches:</h4>${ 
        pairings.map(cigar => 
          `<div class="pairing-item">
            <strong>${cigar.name}</strong><br>
            <em>${cigar.flavor}</em><br>
            <small>Wrapper: ${cigar.wrapper}</small>
          </div>`
        ).join('')}`;
        } else {
          results.innerHTML = '<p>No specific pairings found. Try different beverage types like coffee, whiskey, or wine.</p>';
        }
      };
      
      pairingPanel.style.display = "block";
    }

    function showLoungePanel() {
      const features = dataManager.getLoungeFeatures();
      const content = document.getElementById("loungeContent");
      
      const conciergeDiv = document.getElementById("conciergeMode");
      conciergeDiv.innerHTML = '<h4>üé© Concierge Services:</h4>' +
        '<div class="feature-button" onclick="activateConcierge()">Activate Personal Concierge</div>' +
        '<p>Your personal cigar advisor for premium selections and expert guidance.</p>';
      
      const featuresDiv = document.getElementById("loungeFeatures");
      featuresDiv.innerHTML = `<h4>üèõÔ∏è Lounge Features:</h4>${ 
    features.map(f => 
      `<div class="lesson-item">
        <strong>${f.name}</strong> (${f.status})<br>
        <small>${f.description}</small>
      </div>`
    ).join('')}`;
      
      loungePanel.style.display = "block";
    }

    function startRitualMode() {
      const emotional = dataManager.data.emotional;
      if (emotional.ritualFlows) {
        const flows = Object.keys(emotional.ritualFlows);
        const randomFlow = flows[Math.floor(Math.random() * flows.length)];
        const flow = emotional.ritualFlows[randomFlow];
        
        showSuccess(`üé≠ Ritual Mode: ${randomFlow.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
        
        // Show ritual guidance
        setTimeout(() => {
          alert(`üé≠ Ritual Guidance:\n\nMood: ${flow.mood}\nMusic: ${flow.music}\nLighting: ${flow.lightLevel}\n\nMemory Prompt: ${flow.memoryPrompt}`);
        }, 1000);
      } else {
        showError('Ritual data not available');
      }
    }

    // Placeholder functions for advanced features
    function startCEUTrack(trackId) {
      showSuccess(`Starting CEU track: ${trackId}`);
    }

    function openEducationTrack(trackId) {
      showEducationPanel();
      showSuccess(`Opening education track: ${trackId}`);
    }

    function activateConcierge() {
      showSuccess('üé© Personal Concierge activated. How may I assist you today?');
    }

    const light = new THREE.PointLight(0xffffff, 1, 200);
    light.position.set(10, 10, 10);
    scene.add(light);

    const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
    scene.add(ambientLight);

    function onMouseMove(event) {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);

      raycaster.setFromCamera(mouse, camera);
      const visibleStars = stars.filter(s => s.visible);
      const intersects = raycaster.intersectObjects(visibleStars);

      if (intersects.length > 0) {
        info.textContent = `‚≠ê ${intersects[0].object.name}`;
      } else {
        info.textContent = "üåÄ Flavorverse ‚Äî Ritual Trail Viewer";
      }
    }

    function updateFilter() {
      const selected = Array.from(document.querySelectorAll("#filter input:checked")).map(cb => cb.value);
      stars.forEach(star => {
        star.visible = selected.includes(star.userData.wrapper);
      });
    }

    // Event listeners
    window.addEventListener("mousemove", onMouseMove);
    document.querySelectorAll("#filter input").forEach(cb => cb.addEventListener("change", updateFilter));
    
    window.addEventListener("click", (e) => {
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(stars.filter(s => s.visible));
      if (intersects.length > 0) {
        const obj = intersects[0].object;
        showEnhancedModal(obj);
      }
    });

    // Handle window resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Initialize application
    async function initializeApp() {
      info.textContent = "üåÄ Loading Flavorverse...";
      
      const success = await dataManager.loadAllData();
      if (success) {
        await loadCigars();
        updateFilter();
        animate();
        info.textContent = "üåÄ Flavorverse ‚Äî Ritual Trail Viewer";
        showSuccess('üöÄ Flavorverse fully integrated and ready!');
      } else {
        showError('Failed to initialize application. Some features may be limited.');
        // Continue with basic functionality
        animate();
      }
    }

    // Start the application
    initializeApp().catch(error => {
      console.error('Critical initialization error:', error);
      showError('Application failed to initialize. Please refresh the page.');
    });
  </script>

  <!-- Voice Recorder & Audio Playback -->
  <div id="voicePanel" style="position: absolute; bottom: 20px; left: 20px; z-index: 3; background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #444; display: none;">
    <strong>üé§ Record Your Ritual</strong><br/>
    <button id="startRec">Start</button>
    <button id="stopRec">Stop</button>
    <audio id="playback" controls style="display:none; margin-top:5px;"></audio>
    <a id="downloadLink" download="ritual-memory.webm" style="display:none; color:#f0e6d2;">Download Memory</a>
  </div>

  <!-- GPT Chat Floating Button -->
  <button id="gptBtn" style="position:fixed;bottom:20px;right:20px;z-index:3;background:#5c4033;color:#f0e6d2;padding:10px 14px;border:none;border-radius:4px;cursor:pointer;">üß† Ask the Stars</button>

  <script>
    // Voice recording logic with proper error handling
    let mediaRecorder, audioChunks = [];
    const voicePanel = document.getElementById("voicePanel");
    const startBtn = document.getElementById("startRec");
    const stopBtn = document.getElementById("stopRec");
    const audio = document.getElementById("playback");
    const link = document.getElementById("downloadLink");

    startBtn.onclick = async () => {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Media recording not supported in this browser');
        }
        
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          audio.src = url;
          audio.style.display = 'block';
          link.href = url;
          link.style.display = 'inline';
          // Stop all tracks to release microphone
          stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (error) {
        console.error('Error starting recording:', error);
        showError('Failed to start recording. Please check your microphone permissions.');
      }
    };

    stopBtn.onclick = () => {
      try {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }
      } catch (error) {
        console.error('Error stopping recording:', error);
        showError('Error stopping recording.');
      }
    };

    // GPT assistant integration with improved error handling
    document.getElementById("gptBtn").onclick = () => {
      // Removed alert, implementing proper GPT integration
      const gptPanel = document.createElement('div');
      gptPanel.style.cssText = 'position:fixed;bottom:80px;right:20px;width:300px;background:#1e1e1e;color:#f0e6d2;border:1px solid #444;border-radius:8px;padding:1rem;z-index:999;';
      gptPanel.innerHTML = `
        <div style="font-weight:bold;margin-bottom:8px;">üß† Ask the Stars</div>
        <textarea id="gptInput" placeholder="Ask about pairings, rituals, cigars..." style="width:100%;height:60px;margin-bottom:8px;background:#2c2c2c;border:1px solid #666;color:#fff;padding:5px;"></textarea>
        <button id="gptSend" style="width:100%;padding:8px;background:#c69c6d;border:none;cursor:pointer;font-weight:bold;">Send</button>
        <button id="gptClose" style="float:right;background:transparent;border:none;color:#f0e6d2;cursor:pointer;">√ó</button>
        <div id="gptResponse" style="margin-top:10px;font-style:italic;">Ready to help with your cigar journey...</div>
      `;
      document.body.appendChild(gptPanel);

      document.getElementById('gptClose').onclick = () => gptPanel.remove();
      document.getElementById('gptSend').onclick = async () => {
        const input = document.getElementById('gptInput').value.trim();
        if (!input) {return;}

        const responseDiv = document.getElementById('gptResponse');
        responseDiv.textContent = "The Maestro is thinking...";

        try {
          // Input validation and sanitization
          if (input.length > 500) {
            throw new Error('Message too long. Please keep it under 500 characters.');
          }

          const res = await fetch("https://theecigarmaestro.vercel.app/api/gpt", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ prompt: sanitizeText(input) }),
            signal: AbortSignal.timeout(10000) // 10 second timeout
          });

          if (!res.ok) {
            throw new Error(`Server error: ${res.status}`);
          }

          const data = await res.json();
          if (data && data.response) {
            responseDiv.textContent = `üß† The Maestro says: ${data.response}`;
          } else {
            throw new Error('Invalid response format');
          }
        } catch (error) {
          console.error('GPT request error:', error);
          responseDiv.textContent = "‚ö†Ô∏è Unable to reach The Maestro. Please try again later.";
        }
      };
    };

    // Trigger voice panel on star click
    window.addEventListener("click", (e) => {
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(stars.filter(s => s.visible));
      if (intersects.length > 0) {
        voicePanel.style.display = "block";
      }
    });
  </script>
  
  <!-- Enhanced Feature Scripts -->
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js');
          console.log('‚úÖ Service Worker registered successfully:', registration.scope);
          
          // Listen for service worker messages
          navigator.serviceWorker.addEventListener('message', (event) => {
            const { type, action } = event.data;
            
            if (type === 'SYNC_REQUEST') {
              if (action === 'user-data' && window.storageManager) {
                // Sync user data when requested
                window.storageManager.saveData();
                console.log('üì§ User data synced');
              }
              
              if (action === 'analytics' && window.storageManager) {
                // Sync analytics when requested
                const analytics = window.storageManager.exportData().analytics;
                console.log('üìä Analytics synced:', analytics);
              }
            }
          });
          
          // Register for background sync
          if ('sync' in window.ServiceWorkerRegistration.prototype) {
            registration.sync.register('sync-user-data');
            registration.sync.register('sync-analytics');
          }
          
        } catch (error) {
          console.error('‚ùå Service Worker registration failed:', error);
        }
      });
    }
  </script>
</body>
</html>
